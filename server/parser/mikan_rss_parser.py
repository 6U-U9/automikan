from parser import Parser
from parser.name_parser import NameParser
from parser.ai_name_parser import AiNameParser
from manager.global_manager import GlobalManager
import bs4 as bs
import dateutil

class MikanRssParser(Parser):
    def parse(content: str):
        infos = []
        soup = bs.BeautifulSoup(content, "xml")
        channel = soup.rss.channel
        items = channel.find_all("item")
        for item in items:
            info = {}
            info["link"] = item.link.text
            info["title"] = item.title.text
            info["description"] = item.description.text
            #info["torrent_link"] = item.torrent.link.text
            info["torrent_length"] = int(item.contentLength.text)
            info["torrent_pub_date"] = dateutil.parser.parse(item.torrent.pubDate.text)
            info["torrent_url"] = item.enclosure["url"]
            if GlobalManager.global_config.enable_ai_parser:
                info["torrent_title"] = AiNameParser.parse(item.description.text)
            else:
                info["torrent_title"] = NameParser.parse(item.description.text)
            infos.append(info)
        return infos

if __name__ == "__main__":
    example = r'''<?xml version="1.0" encoding="utf-8"?><rss version="2.0"><channel><title>Mikan Project - 我的番组</title><link>http://mikanani.me/RSS/MyBangumi?token=diMoVXkH%2FvLPU1Sxf8eoRcZqoG8Z4YvrZOhXhzj0X8g%3D</link><description>Mikan Project - 我的番组</description><item><guid isPermaLink="false">[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][简繁内封]</guid><link>https://mikanani.me/Home/Episode/afe36e9288a13598b0bd2fd1113aa6dd7ff3b63c</link><title>[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][简繁内封]</title><description>[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][简繁内封][338.33 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/afe36e9288a13598b0bd2fd1113aa6dd7ff3b63c</link><contentLength>354764704</contentLength><pubDate>2024-12-25T00:13:56.624</pubDate></torrent><enclosure type="application/x-bittorrent" length="354764704" url="https://mikanani.me/Download/20241225/afe36e9288a13598b0bd2fd1113aa6dd7ff3b63c.torrent" /></item><item><guid isPermaLink="false">[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][简体内嵌]</guid><link>https://mikanani.me/Home/Episode/9c25b0ea2bb2b565683c87fd7e1c39bda135df57</link><title>[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][简体内嵌]</title><description>[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][简体内嵌][486.83 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/9c25b0ea2bb2b565683c87fd7e1c39bda135df57</link><contentLength>510478240</contentLength><pubDate>2024-12-25T00:11:45.123</pubDate></torrent><enclosure type="application/x-bittorrent" length="510478240" url="https://mikanani.me/Download/20241225/9c25b0ea2bb2b565683c87fd7e1c39bda135df57.torrent" /></item><item><guid isPermaLink="false">[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][繁体内嵌]</guid><link>https://mikanani.me/Home/Episode/fa787c7786ceda0d00ea82ed8855c7cc60a6fd9f</link><title>[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][繁体内嵌]</title><description>[桜都字幕组] 在地下城寻求邂逅是否搞错了什么 第五季 / Dungeon ni Deai o Motomeru no wa Machigatte Iru Darouka： Familia Myth V [11][1080p][繁体内嵌][486.84 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/fa787c7786ceda0d00ea82ed8855c7cc60a6fd9f</link><contentLength>510488736</contentLength><pubDate>2024-12-25T00:10:06.455</pubDate></torrent><enclosure type="application/x-bittorrent" length="510488736" url="https://mikanani.me/Download/20241225/fa787c7786ceda0d00ea82ed8855c7cc60a6fd9f.torrent" /></item><item><guid isPermaLink="false">[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (CR 1920x1080 AVC AAC MKV)</guid><link>https://mikanani.me/Home/Episode/95982ee994c7ef543cadd8eb5afef6c31f44fc69</link><title>[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (CR 1920x1080 AVC AAC MKV)</title><description>[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (CR 1920x1080 AVC AAC MKV)[1.34 GB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/95982ee994c7ef543cadd8eb5afef6c31f44fc69</link><contentLength>1438814080</contentLength><pubDate>2024-12-23T23:32:41.792</pubDate></torrent><enclosure type="application/x-bittorrent" length="1438814080" url="https://mikanani.me/Download/20241223/95982ee994c7ef543cadd8eb5afef6c31f44fc69.torrent" /></item><item><guid isPermaLink="false">[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (ABEMA 1920x1080 AVC AAC MP4)</guid><link>https://mikanani.me/Home/Episode/c7fa91cb83982d9166231bbabc5d89cefbf679d1</link><title>[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (ABEMA 1920x1080 AVC AAC MP4)</title><description>[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (ABEMA 1920x1080 AVC AAC MP4)[712.5 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/c7fa91cb83982d9166231bbabc5d89cefbf679d1</link><contentLength>747110400</contentLength><pubDate>2024-12-23T22:32:25.019</pubDate></torrent><enclosure type="application/x-bittorrent" length="747110400" url="https://mikanani.me/Download/20241223/c7fa91cb83982d9166231bbabc5d89cefbf679d1.torrent" /></item><item><guid isPermaLink="false">[Up to 21°C] 鸭乃桥论的禁忌推理 第2季 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (B-Global 1920x1080 HEVC AAC MKV)</guid><link>https://mikanani.me/Home/Episode/5d567ff429c75bc10f2303ed2bbf37300a555a40</link><title>[Up to 21°C] 鸭乃桥论的禁忌推理 第2季 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (B-Global 1920x1080 HEVC AAC MKV)</title><description>[Up to 21°C] 鸭乃桥论的禁忌推理 第2季 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (B-Global 1920x1080 HEVC AAC MKV)[248.51 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/5d567ff429c75bc10f2303ed2bbf37300a555a40</link><contentLength>260581616</contentLength><pubDate>2024-12-23T22:31:20.181</pubDate></torrent><enclosure type="application/x-bittorrent" length="260581616" url="https://mikanani.me/Download/20241223/5d567ff429c75bc10f2303ed2bbf37300a555a40.torrent" /></item><item><guid isPermaLink="false">[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (Baha 1920x1080 AVC AAC MP4)</guid><link>https://mikanani.me/Home/Episode/42fc79f0a652d0356e3fcbefd985cfec72040fce</link><title>[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (Baha 1920x1080 AVC AAC MP4)</title><description>[Up to 21°C] 鸭乃桥论的禁忌推理 / Kamonohashi Ron no Kindan Suiri 2nd Season - 25 (Baha 1920x1080 AVC AAC MP4)[383.17 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/42fc79f0a652d0356e3fcbefd985cfec72040fce</link><contentLength>401782880</contentLength><pubDate>2024-12-23T22:30:57.852</pubDate></torrent><enclosure type="application/x-bittorrent" length="401782880" url="https://mikanani.me/Download/20241223/42fc79f0a652d0356e3fcbefd985cfec72040fce.torrent" /></item><item><guid isPermaLink="false">【喵萌奶茶屋】★10月新番★[Chi。-关于地球的运动- / Chi. Chikyuu no Undou ni Tsuite][12][1080p][简日双语][招募翻译]</guid><link>https://mikanani.me/Home/Episode/c5de601ca7587959ebf7702b0b7c246cbb4a87ac</link><title>【喵萌奶茶屋】★10月新番★[Chi。-关于地球的运动- / Chi. Chikyuu no Undou ni Tsuite][12][1080p][简日双语][招募翻译]</title><description>【喵萌奶茶屋】★10月新番★[Chi。-关于地球的运动- / Chi. Chikyuu no Undou ni Tsuite][12][1080p][简日双语][招募翻译][188.32 MB]</description><torrent xmlns="https://mikanani.me/0.1/"><link>https://mikanani.me/Home/Episode/c5de601ca7587959ebf7702b0b7c246cbb4a87ac</link><contentLength>197467840</contentLength><pubDate>2024-12-22T03:52:41.62</pubDate></torrent><enclosure type="application/x-bittorrent" length="197467840" url="https://mikanani.me/Download/20241222/c5de601ca7587959ebf7702b0b7c246cbb4a87ac.torrent" /></item></channel></rss>'''
    infos = MikanRssParser.parse(example)
    pass